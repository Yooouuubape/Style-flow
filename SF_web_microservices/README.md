# Документация по системе микросервисов Style Flow

## Содержание
1. [Введение](#введение)
2. [Архитектура системы](#архитектура-системы)
3. [Микросервисы](#микросервисы)
   - [User Service (Сервис пользователей)](#user-service-сервис-пользователей)
   - [Event Service (Сервис событий)](#event-service-сервис-событий)
   - [Resource Service (Сервис ресурсов)](#resource-service-сервис-ресурсов)
   - [Client Service (Сервис клиентов)](#client-service-сервис-клиентов)
   - [Payment Service (Сервис платежей)](#payment-service-сервис-платежей)
   - [Auth Service (Сервис аутентификации)](#auth-service-сервис-аутентификации)
   - [Gateway Service (Сервис API-шлюза)](#gateway-service-сервис-api-шлюза)
4. [Событийно-ориентированное взаимодействие](#событийно-ориентированное-взаимодействие)
5. [Запуск и развертывание](#запуск-и-развертывание)
6. [Мониторинг и обслуживание](#мониторинг-и-обслуживание)
7. [Примеры использования](#примеры-использования)

## Введение

Система микросервисов Style Flow представляет собой распределенное приложение, состоящее из нескольких независимых сервисов, каждый из которых отвечает за свою область бизнес-логики. Система разработана с использованием событийно-ориентированной архитектуры (Event-Driven Architecture) и обеспечивает высокую масштабируемость, отказоустойчивость и гибкость.

Ключевые технологии, используемые в системе:
- **Python и Flask** для реализации API микросервисов
- **PostgreSQL** для хранения данных
- **Apache Kafka** для асинхронного обмена сообщениями между сервисами
- **Docker** и **Docker Compose** для контейнеризации и оркестрации
- **JWT** для аутентификации и авторизации

## Архитектура системы

Система построена на принципах микросервисной архитектуры, где каждый сервис:
- Имеет свою собственную базу данных
- Предоставляет API для взаимодействия с ним
- Обменивается событиями с другими сервисами через Kafka
- Выполняет определенную бизнес-функцию

Общая схема взаимодействия:

1. Клиентские запросы поступают через Gateway Service
2. Gateway Service маршрутизирует запросы к соответствующим микросервисам
3. Микросервисы обрабатывают запросы и возвращают результаты
4. Для асинхронного взаимодействия сервисы публикуют события в Kafka
5. Другие сервисы подписываются на эти события и реагируют на них

## Микросервисы

### User Service (Сервис пользователей)

**Описание**: Управляет информацией о пользователях системы.

**API-эндпоинты**:
- `GET /health` - проверка состояния сервиса
- `GET /users` - получение списка пользователей
- `GET /users/{id}` - получение информации о конкретном пользователе
- `POST /users` - создание пользователя
- `PUT /users/{id}` - обновление данных пользователя
- `DELETE /users/{id}` - удаление пользователя
- `GET /users/{id}/integrations` - получение интеграций пользователя
- `GET /users/{id}/activity` - получение истории активности пользователя

**Kafka Producer Topics**:
- `user-events` - события, связанные с изменениями пользователей

**Kafka Consumer Topics**:
- `auth.user.registered` - события регистрации пользователей от Auth Service
- `user.role_changed` - события изменения ролей пользователей
- `user.deactivated` - события деактивации пользователей

**База данных**: Хранит профили пользователей, их роли, настройки и историю активности.

### Event Service (Сервис событий)

**Описание**: Управляет событиями и мероприятиями в системе.

**API-эндпоинты**:
- `GET /health` - проверка состояния сервиса
- `GET /events` - получение списка событий
- `GET /events/{id}` - получение информации о конкретном событии
- `POST /events` - создание события
- `PUT /events/{id}` - обновление события
- `DELETE /events/{id}` - отмена события
- `GET /categories` - получение категорий событий
- `GET /events/{id}/registrations` - получение регистраций на событие
- `POST /events/{id}/register` - регистрация на событие

**Kafka Producer Topics**:
- `event-events` - события, связанные с изменениями в мероприятиях
- `event-registrations` - события, связанные с регистрациями на мероприятия

**Kafka Consumer Topics**:
- `user-events` - события, связанные с пользователями
- `payment-events` - события, связанные с платежами
- `resource-events` - события, связанные с ресурсами

**База данных**: Хранит информацию о событиях, их категориях, расписании, регистрациях участников.

### Resource Service (Сервис ресурсов)

**Описание**: Управляет ресурсами, необходимыми для проведения мероприятий.

**API-эндпоинты**:
- `GET /health` - проверка состояния сервиса
- `GET /resources` - получение списка ресурсов
- `GET /resources/{id}` - получение информации о конкретном ресурсе
- `POST /resources` - создание ресурса
- `PUT /resources/{id}` - обновление ресурса
- `DELETE /resources/{id}` - удаление ресурса
- `GET /resource-types` - получение типов ресурсов
- `POST /resources/{id}/allocate` - выделение ресурса
- `GET /allocations` - получение выделений ресурсов

**Kafka Producer Topics**:
- `resource-events` - события, связанные с изменениями в ресурсах
- `resource-allocations` - события выделения ресурсов

**Kafka Consumer Topics**:
- `event-events` - события, связанные с мероприятиями
- `user-events` - события, связанные с пользователями
- `payment-events` - события, связанные с платежами

**База данных**: Хранит информацию о ресурсах, их типах, доступности, выделениях.

### Client Service (Сервис клиентов)

**Описание**: Управляет информацией о клиентах системы.

**API-эндпоинты**:
- `GET /health` - проверка состояния сервиса
- `GET /clients` - получение списка клиентов
- `GET /clients/{id}` - получение информации о конкретном клиенте
- `POST /clients` - создание клиента
- `PUT /clients/{id}` - обновление клиента
- `DELETE /clients/{id}` - удаление клиента
- `GET /clients/{id}/contacts` - получение контактов клиента
- `POST /clients/{id}/contacts` - добавление контакта клиента
- `GET /clients/{id}/activity` - получение истории активности клиента
- `POST /clients/{id}/activity` - логирование активности клиента

**Kafka Producer Topics**:
- `client-events` - события, связанные с изменениями клиентов

**Kafka Consumer Topics**:
- `user-events` - события, связанные с пользователями
- `event-events` - события, связанные с мероприятиями
- `payment-events` - события, связанные с платежами

**База данных**: Хранит информацию о клиентах, их контактах, предпочтениях, историю взаимодействия.

### Payment Service (Сервис платежей)

**Описание**: Управляет платежами и финансовыми операциями в системе.

**API-эндпоинты**:
- `GET /health` - проверка состояния сервиса
- `GET /payments` - получение списка платежей
- `GET /payments/{id}` - получение информации о конкретном платеже
- `POST /payments` - создание платежа
- `GET /payment-methods` - получение методов оплаты
- `POST /payment-methods` - добавление метода оплаты
- `POST /payments/{id}/refund` - возврат платежа
- `GET /transactions` - получение транзакций

**Kafka Producer Topics**:
- `payment-events` - события, связанные с платежами и транзакциями

**Kafka Consumer Topics**:
- `user-events` - события, связанные с пользователями
- `event-events` - события, связанные с мероприятиями
- `resource-events` - события, связанные с ресурсами
- `client-events` - события, связанные с клиентами

**База данных**: Хранит информацию о платежах, методах оплаты, транзакциях, счетах.

### Auth Service (Сервис аутентификации)

**Описание**: Обеспечивает аутентификацию и авторизацию пользователей.

**API-эндпоинты**:
- `GET /health` - проверка состояния сервиса
- `POST /auth/register` - регистрация нового пользователя
- `POST /auth/login` - аутентификация пользователя
- `POST /auth/refresh` - обновление токена доступа
- `POST /auth/logout` - выход из системы
- `GET /auth/me` - получение информации о текущем пользователе
- `POST /auth/reset-password` - сброс пароля

**Kafka Producer Topics**:
- `auth.user.registered` - события регистрации пользователей
- `auth.user.login` - события входа пользователей в систему
- `auth.user.logout` - события выхода пользователей из системы

**Kafka Consumer Topics**:
- События от всех сервисов для обновления информации о пользователях

**База данных**: Хранит учетные данные пользователей, токены, сессии.

### Gateway Service (Сервис API-шлюза)

**Описание**: Обеспечивает единую точку входа для всех клиентских запросов.

**API-эндпоинты**:
- Предоставляет маршрутизацию ко всем API-эндпоинтам других сервисов

**Kafka Consumer Topics**:
- События от всех сервисов для мониторинга активности API

**Функциональность**:
- Маршрутизация запросов
- Балансировка нагрузки
- Проверка аутентификации
- Логирование запросов
- Ограничение скорости запросов
- Кэширование ответов

## Событийно-ориентированное взаимодействие

Взаимодействие между микросервисами построено на событийно-ориентированной архитектуре с использованием Apache Kafka:

1. **Публикация событий**: Каждый сервис публикует события о значимых изменениях в своей области ответственности.
2. **Подписка на события**: Сервисы подписываются на нужные им события от других сервисов.
3. **Обработка событий**: При получении события, сервис выполняет соответствующие действия.

**Основные типы событий**:

- **Пользовательские события**:
  - `user.created` - создание пользователя
  - `user.updated` - обновление пользователя
  - `user.deactivated` - деактивация пользователя
  - `user.role_changed` - изменение роли пользователя

- **События мероприятий**:
  - `event.created` - создание мероприятия
  - `event.updated` - обновление мероприятия
  - `event.cancelled` - отмена мероприятия
  - `event.registration.created` - создание регистрации на мероприятие
  - `event.registration.cancelled` - отмена регистрации на мероприятие

- **События ресурсов**:
  - `resource.created` - создание ресурса
  - `resource.updated` - обновление ресурса
  - `resource.allocated` - выделение ресурса
  - `resource.released` - освобождение ресурса

- **События клиентов**:
  - `client.created` - создание клиента
  - `client.updated` - обновление клиента
  - `client.contact.added` - добавление контакта клиента
  - `client.activity.logged` - логирование активности клиента

- **События платежей**:
  - `payment.created` - создание платежа
  - `payment.completed` - завершение платежа
  - `payment.failed` - сбой платежа
  - `payment.refunded` - возврат платежа

## Запуск и развертывание

### Предварительные требования

- Docker и Docker Compose
- Git
- Make (опционально, для использования Makefile)

### Клонирование репозитория

```bash
git clone https://github.com/your-organization/style-flow.git
cd style-flow
```

### Настройка переменных окружения

Создайте файл `.env` в корневой директории проекта:

```
# Общие настройки
ENVIRONMENT=development
LOG_LEVEL=INFO

# Настройки PostgreSQL
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_HOST=postgres
POSTGRES_PORT=5432

# Настройки Kafka
KAFKA_BOOTSTRAP_SERVERS=kafka:9092
KAFKA_GROUP_ID=style-flow

# Настройки JWT
JWT_SECRET_KEY=your-secret-key
JWT_ACCESS_TOKEN_EXPIRES=3600
JWT_REFRESH_TOKEN_EXPIRES=604800
```

### Запуск системы

Используйте Docker Compose для запуска всех сервисов:

```bash
docker-compose up -d
```

Для запуска определенных сервисов:

```bash
docker-compose up -d gateway-service user-service auth-service
```

### Проверка статуса

```bash
docker-compose ps
```

### Остановка системы

```bash
docker-compose down
```

## Мониторинг и обслуживание

### Просмотр логов

Для просмотра логов всех сервисов:

```bash
docker-compose logs -f
```

Для просмотра логов конкретного сервиса:

```bash
docker-compose logs -f user-service
```

### Проверка состояния сервисов

Каждый сервис имеет эндпоинт `/health` для проверки его состояния:

```bash
curl http://localhost:8080/user-service/health
```

### Резервное копирование данных

Для создания резервной копии базы данных:

```bash
docker-compose exec postgres pg_dump -U postgres -d user_service > user_service_backup.sql
```

## Примеры использования

### Регистрация пользователя

```bash
curl -X POST http://localhost:8080/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user1",
    "email": "user1@example.com",
    "password": "password123",
    "first_name": "Иван",
    "last_name": "Иванов"
  }'
```

### Аутентификация пользователя

```bash
curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user1@example.com",
    "password": "password123"
  }'
```

### Создание события

```bash
curl -X POST http://localhost:8080/events \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "title": "Конференция по микросервисам",
    "description": "Обсуждение архитектуры микросервисов",
    "start_date": "2023-12-01T10:00:00",
    "end_date": "2023-12-01T18:00:00",
    "location": "Москва, ул. Примерная, 123",
    "capacity": 100,
    "category_id": 1
  }'
```

### Создание клиента

```bash
curl -X POST http://localhost:8080/clients \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "name": "ООО Пример",
    "type": "organization",
    "industry": "IT",
    "description": "IT-компания"
  }'
```

### Создание платежа

```bash
curl -X POST http://localhost:8080/payments \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "amount": 5000,
    "currency": "RUB",
    "description": "Оплата участия в конференции",
    "client_id": 1,
    "event_id": 1,
    "payment_method_id": 1
  }'
```

### Выделение ресурса

```bash
curl -X POST http://localhost:8080/resources/1/allocate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "event_id": 1,
    "start_time": "2023-12-01T10:00:00",
    "end_time": "2023-12-01T18:00:00",
    "quantity": 1
  }'
``` 